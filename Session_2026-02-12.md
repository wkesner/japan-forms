# Session Log — 2026-02-12

Continues from Session_2026-02-11.md. Read that first for full context.

## What Was Done

### 1. Committed & Pushed NHI Work (from Feb 11)

Commit `9ea753b`: "Add NHI form support: scraper, template, and walkthroughs for 15 Tokyo wards"
- 79 files changed, 33k insertions
- Only staged latest version of each NHI walkthrough per ward (user requested this)
- Excluded `Adachi_Residence_v1_TEST.PDF` test file
- Older NHI versions (v1, v2 etc.) remain local/unstaged

### 2. Dynamic Zones for Non-Residence Forms

**Problem**: NHI forms use `DEFAULT_ZONES` (hardcoded y-coordinates for residence forms), causing fields to be misassigned to wrong sections ("Person Table" for admin fields, "Instructions" for unrelated content). Crops were wrong or missing.

**Fix in `pipeline.py`**:
- `process_pdf()` now sets `use_dynamic_zones = True` for any `form_id != "residence_registration"`
- After field extraction, creates dynamic zones via `create_dynamic_zones_for_fields()` using actual field y-positions
- Residence forms still use `DEFAULT_ZONES` — no regression

**Key code** (around line 3230):
```python
if form_id == "residence_registration":
    zones = DEFAULT_ZONES
else:
    use_dynamic_zones = True
    zones = DEFAULT_ZONES  # placeholder until fields extracted
```
Then around line 3380:
```python
if has_ocr_fields or use_dynamic_zones:
    # creates dynamic zones from field positions
```

### 3. Non-Overlapping Zone Boundaries

**Problem**: `create_dynamic_zones_for_fields()` added ±15pt padding to each zone, and `fields_in_zone()` added another ±10pt. Fields near boundaries appeared in multiple zones.

**Fix**: Rewrote zone boundary calculation to use midpoints between consecutive chunks instead of padding. First zone starts at `y_min - 5`, last zone ends at `y_max + 5`, intermediate boundaries are midpoints between adjacent chunks' y ranges.

### 4. Larger Zone Size for Text-Based Forms

Changed `max_fields_per_zone` from 12 to 20 for non-OCR dynamic zones. OCR forms still use 12. This reduced NHI from 11 zones to 7 zones, cutting page count significantly.

### 5. Crop Images on Continuation Pages

**Problem**: When a chunk's field explanations overflowed one page, the continuation page had no crop image — user couldn't match numbered red circles to the form.

**Fix**: Save the annotated crop image bytes after first render (`img_bytes = img_buf.getvalue()`). On continuation pages, create a new `ImageReader` from the saved bytes and redraw the crop. User can now see all numbered annotations on every page.

### 6. Reduced Bottom Margin for Final Entries

When only ≤2 entries remain in a chunk, reduce the page-break threshold from 45pt to 15pt. This squeezes the last couple fields onto the current page rather than creating a near-empty overflow page.

### 7. Short Fragment Filter

**Problem**: Text clustering extracts fragments like "す。", "する", "しない", "くだ", "の世" — partial hiragana from table cells. These produce useless translations.

**Fix**: Added filter in the translation loop (around line 3453):
```python
if len(text) <= 3 and not any('\u4e00' <= ch <= '\u9fff' for ch in text):
    continue
```
Skips fields ≤3 chars with no kanji. Preserves useful short fields like "氏名", "住所", "性別" which always contain kanji.

## Key Files Modified

| File | Changes |
|------|---------|
| `scripts/pipeline.py` | Dynamic zones for non-residence forms, non-overlapping boundaries, crop on continuation pages, bottom margin reduction, fragment filter |

## State of Outputs

### NHI Walkthroughs (committed at v3 latest)
15 wards generated. Latest committed versions:
Adachi(v3), Arakawa(v1), Chuo(v2), Itabashi(v3), Katsushika(v2), Kita(v2), Minato(v1), Nakano(v2), Nerima(v1), Ota(v4), Setagaya(v1), Shinagawa(v1), Suginami(v3), Taito(v1), Toshima(v4)

### Test outputs (local, NOT committed)
- `Adachi_NHIapp_v4.PDF` through `v8.PDF` — test iterations during zone/crop fixes
- `Adachi_Residence_v2.PDF`, `v3.PDF` — regression test outputs
- Multiple older NHI versions per ward (v1, v2 etc.)

## Uncommitted Changes
- All pipeline.py changes from this session (dynamic zones, crop continuation, fragment filter)
- Test walkthrough outputs (v4-v8 NHI, v2-v3 Residence for Adachi)
- Should commit pipeline.py changes; can delete test outputs

## API Key

**Working key**: `/Users/williamkesner/Documents/API-Keys/JF4.rtf` (RTF format, extract between `\cf0` and `}`)
- Key: `sk-ant-api03-E7Jmfj...ekPHjwAA`
- The key in `/Users/williamkesner/Documents/deep-japan/Japan-Forms API Key.txt` is **expired** (401 auth error)

## Pending / Next Steps

- **Commit pipeline.py changes** (dynamic zones, crop continuation, fragment filter)
- **Re-generate all NHI walkthroughs** with fixed pipeline (current committed versions use old DEFAULT_ZONES)
- **Re-generate all residence walkthroughs** to pick up fragment filter (optional — existing ones work, just have a few junk fields)
- 4 empty NHI wards still need better scraping targets: Edogawa, Koto, Meguro, Sumida
- Clean up test output files before committing
- Consider whether dynamic zone section names ("Section 1", "Section 2") could be improved with form-specific names
