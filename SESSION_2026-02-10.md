# Session Notes: February 10, 2026

## Project Overview
Japan Forms Translation Pipeline - generates bilingual walkthrough PDFs for Japanese government registration forms (住民異動届) across 23 Tokyo wards.

## Current State
- **47 walkthroughs generated** with standardized naming
- **49 source PDFs** tracked in `input/tokyo/{ward}/`
- **Setagaya skipped** (2 PDFs) due to OCR arrow placement issues

## Workflow
```bash
cd japan-forms && source venv/bin/activate
export ANTHROPIC_API_KEY="your-key"

# Regenerate all
python scripts/regenerate_all.py

# Single form
python scripts/pipeline.py input/tokyo/adachi/*.pdf

# Quality check
python scripts/quality_check.py
```

## What Was Done This Session

### 1. Fixed Japanese Font Rendering
- Problem: reportlab showed "nnnnn" placeholders for Japanese text
- Solution: Use Arial Unicode TTF (`/System/Library/Fonts/Supplemental/Arial Unicode.ttf`) on macOS
- TTC fonts with PostScript outlines don't work with reportlab

### 2. Added OCR Support for Scanned PDFs
- Uses Claude Vision API to extract text from image-based PDFs
- Returns y_pct/x_pct (0-100) percentages converted to PDF coordinates
- Works but arrow placement is inaccurate (see Known Issues)

### 3. Multi-Page Form Support
- Each field tracks its source `page` attribute
- `_split_zone_into_chunks()` groups fields by page first
- Correct page image selected for each zone chunk

### 4. Mini-Map Feature
- Bottom-right thumbnail shows full form page
- Red rectangle indicates current cropped section
- "Form p.1" label shows source page number

### 5. Field Deduplication
- `deduplicate_fields()` removes overlapping extractions
- Keeps field with more characters when positions overlap
- Fixed duplicate annotation issue (e.g., household head field appearing twice)

### 6. Directory Restructure
- Renamed `downloads/` to `input/` for clarity
- Source PDFs now tracked in git for transparency
- Updated `.gitignore`, `PIPELINE.md`, `scraper.py`

### 7. Standardized Naming
- Format: `ward_formtype_v1_walkthrough.pdf`
- Types: `registration`, `movein`, `moveout`, `mail`, `example`, `english`, `mynumber`, `guide`, `homepage`, `form`
- `scripts/regenerate_all.py` handles batch renaming

## Known Issues

### Setagaya OCR Arrow Placement (Deferred)
- **Forms affected**: `setagaya/tenshutsu.pdf`, `setagaya/juuminidoutodoke.pdf`
- **Symptom**: Numbered circles and leader lines point to wrong locations
- **Cause**: Coordinate mismatch for scanned forms. Setagaya PDFs are 960x540 pts (16:9 landscape), not standard A4. Claude Vision returns position percentages, but mapping to cropped image coordinates is off.
- **Status**: Deferred for future computer vision work. Extractable-text forms work correctly.

### Quality Check Warnings (Minor)
- 45 warnings, 0 errors
- Mostly long lines and "polite verb ending" grammar descriptions instead of translations
- Not blocking - walkthroughs are usable

## Key Files

| File | Purpose |
|------|---------|
| `scripts/pipeline.py` | Core translation + PDF generation |
| `scripts/regenerate_all.py` | Batch regeneration with naming |
| `scripts/scraper.py` | Download forms from ward websites |
| `scripts/quality_check.py` | Validate walkthrough quality |
| `scripts/find_gaps.py` | Find untranslated terms |
| `data/fields/dictionary.json` | 583+ translation entries |

## Key Functions in pipeline.py

| Function | Purpose |
|----------|---------|
| `ocr_with_vision()` | Claude Vision OCR for scanned pages |
| `deduplicate_fields()` | Remove overlapping field extractions |
| `_split_zone_into_chunks()` | Group by page, split into max 15 fields |
| `annotate_section_image()` | Draw numbered circles + leader lines |
| `crop_section()` | Crop page image to zone (20px padding) |
| `generate_guide()` | Assemble final PDF with all pages |

## Translation Hierarchy
1. **Dictionary** - Exact match (free, instant)
2. **Fragment** - Partial match combining known terms (free)
3. **LLM** - Claude Sonnet fallback (costs ~$0.003/call)

## Trash Guide PDFs Downloaded

Downloaded English trash disposal guides for 17 Tokyo wards to `input/tokyo_trash/`:

| Status | Wards |
|--------|-------|
| **Text-based (14)** | adachi, bunkyo, edogawa, meguro, minato, nakano, nerima, ota, setagaya, shibuya, shinjuku, suginami, taito |
| **Scanned (3)** | kita, shinagawa, sumida |
| **Missing (6)** | arakawa, chuo, itabashi, katsushika, koto, toshima |

Ready for translation pipeline adaptation.

## Cost Analysis for Scaling

**Tokyo (done):** ~$5 for 23 wards moving docs

**Extrapolation to all 1,750 Japanese municipalities:**

| Phase | Scope | Est. Cost | Notes |
|-------|-------|-----------|-------|
| 1 | Tokyo 23 wards | $5 | Done - dictionary seeded |
| 2 | 47 prefectural capitals | ~$30 | High foreign population |
| 3 | Top 100 tourist/expat cities | ~$50 | Covers 60%+ of actual need |
| 4 | All 1,750 municipalities | ~$150-200 | Dictionary mature, mostly lookups |

**Key insight:** Dictionary compounds over time. Tokyo front-loaded 60-70% of common field vocabulary. Rural wards use similar standardized forms, so marginal cost per ward decreases significantly.

## Notes for Future Work
- Don't let perfect be the enemy of good - most wards don't have guides at all
- Setagaya OCR fix would require rethinking coordinate systems for non-A4 scans
- Consider adding more form types as they're discovered
- Quality check "polite verb ending" warnings could be cleaned up in dictionary
- Trash guides ready for pipeline adaptation (14 text-based PDFs)
- Consider phased rollout to prefectural capitals before full national coverage
